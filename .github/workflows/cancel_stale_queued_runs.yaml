name: Cancel stale queued runs

on:
  schedule:
    - cron: "0 * * * *"   # runs every hour
  workflow_dispatch:       # optional, for manual triggering

permissions:
  actions: write
  contents: read

jobs:
  cancel-stale-runs:
    runs-on: ubuntu-24.04

    steps:
      - name: Cancel queued runs older than 24 hours
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          echo "Checking for stale queued workflow runs..."

          # Fetch queued workflow runs
          runs=$(gh api \
            -H "Accept: application/vnd.github+json" \
            /repos/$REPO/actions/runs \
            --jq '.workflow_runs[] | select(.status=="queued") | {id: .id, created_at: .created_at}')

          if [ -z "$runs" ]; then
            echo "No queued runs found."
            exit 0
          fi

          echo "$runs" | jq -c '.' | while read run; do
            run_id=$(echo $run | jq -r '.id')
            created_at=$(echo $run | jq -r '.created_at')

            # Skip if run_id or created_at are empty
            if [ -z "$run_id" ] || [ -z "$created_at" ]; then
              continue
            fi

            # Compute age in hours
            age_hours=$(( ($(date -u +%s) - $(date -d "$created_at" -u +%s)) / 3600 ))

            echo "Run $run_id has been queued for $age_hours hours."

            if [ "$age_hours" -gt 24 ]; then
              echo "Cancelling run $run_id..."
              gh api \
                -X POST \
                -H "Accept: application/vnd.github+json" \
                /repos/$REPO/actions/runs/$run_id/cancel
            fi
          done
